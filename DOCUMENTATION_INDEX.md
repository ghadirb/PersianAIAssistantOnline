# ğŸ“‘ ÙÙ‡Ø±Ø³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ø¶Ø¨Ø· ØµØ¯Ø§ÛŒ ØªØ±Ú©ÛŒØ¨ÛŒ

## ğŸ¯ Ø´Ø±ÙˆØ¹ Ø³Ø±ÛŒØ¹

Ø§Ú¯Ø± ØªØ§Ø²Ù‡ Ø´Ø±ÙˆØ¹ Ú©Ø±Ø¯ÛŒâ€ŒØ¯ØŒ Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø®ÙˆØ§Ù†ÛŒØ¯:

**ğŸ‘‰ [README_HYBRID_VOICE_SYSTEM.md](README_HYBRID_VOICE_SYSTEM.md)** - Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ 5 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ

---

## ğŸ“š Ø¯Ø§Ú©ÙˆÙ…Ù†ØªÛŒØ´Ù† Ú©Ø§Ù…Ù„

### 1ï¸âƒ£ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ùˆ Ø·Ø±Ø§Ø­ÛŒ

**ğŸ“– [VOICE_RECORDING_ARCHITECTURE.md](VOICE_RECORDING_ARCHITECTURE.md)**
- Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…
- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±
- Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø³ÛŒØ³ØªÙ…
- Ù…Ø¯Ù„ threading
- Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ù†Ø§Ø¨Ø¹
- ØªÙ†Ø¸ÛŒÙ…Ø§Øª

**Ù…ÙˆØ¶ÙˆØ¹Ø§Øª:**
- [ ] Ù†Ù…ÙˆØ¯Ø§Ø± Ù„Ø§ÛŒÙ‡â€ŒØ§ÛŒ (Layered Architecture)
- [ ] Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø± Ø¶Ø¨Ø· ØµØ¯Ø§ (Recording Workflow)
- [ ] Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø± ØªØ¬Ø²ÛŒÙ‡ Ùˆ ØªØ­Ù„ÛŒÙ„ (Analysis Workflow)
- [ ] Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø± Ù‡Ø´Ø¯Ø§Ø± (Alert Workflow)
- [ ] Data Flow
- [ ] API Interfaces
- [ ] Threading Model
- [ ] Configuration Details
- [ ] Performance Metrics
- [ ] Permissions

---

### 2ï¸âƒ£ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§ØªØµØ§Ù„ (Integration)

**ğŸ“– [INTEGRATION_GUIDE.md](INTEGRATION_GUIDE.md)**
- Ù†Ø­ÙˆÙ‡ Ø§ØªØµØ§Ù„ Ø¯Ø± Activities
- Code examples Ø¨Ø±Ø§ÛŒ Ù‡Ø± Activity
- Layout XML updates
- Permission handling
- Test procedures

**Activities Ø´Ø§Ù…Ù„:**
- [ ] MainActivity.kt - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ú†Øª
- [ ] BaseChatActivity.kt - Ú©Ù„Ø§Ø³ Ù¾Ø§ÛŒÙ‡
- [ ] AIChatActivity.kt - Chat AI
- [ ] VoiceNavigationAssistantActivity.kt - Ø¯Ø³ØªÛŒØ§Ø± ØµÙˆØªÛŒ

**Ù…ÙˆØ¶ÙˆØ¹Ø§Øª:**
- [ ] Code samples
- [ ] Layout XML examples
- [ ] Permission checks
- [ ] Error handling
- [ ] Testing guide

---

### 3ï¸âƒ£ ØªØ³Øª Ùˆ Ø±ÙØ¹ Ø¹ÛŒØ¨

**ğŸ“– [TESTING_DEBUGGING_GUIDE.md](TESTING_DEBUGGING_GUIDE.md)**
- Unit tests Ú©Ø§Ù…Ù„
- Integration tests
- Device tests
- Debugging strategies
- Performance analysis
- Error scenarios

**Ù…ÙˆØ¶ÙˆØ¹Ø§Øª:**
- [ ] Unit Tests for HybridVoiceRecorder
- [ ] Unit Tests for VoiceRecordingHelper
- [ ] Integration Tests for Service
- [ ] Device Test Scenarios
- [ ] Manual Testing Checklist
- [ ] Log Filtering Commands
- [ ] Debug Points
- [ ] Profiling Guide
- [ ] Performance Metrics
- [ ] Common Errors & Solutions

---

### 4ï¸âƒ£ Ø®Ù„Ø§ØµÙ‡ Ø­Ù„

**ğŸ“– [SOLUTION_SUMMARY.md](SOLUTION_SUMMARY.md)**
- Ø®Ù„Ø§ØµÙ‡ Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ø­Ù„â€ŒÙ‡Ø§
- ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯â€ŒØ´Ø¯Ù‡
- Ù…Ø±Ø§Ø­Ù„ Ø§Ø¬Ø±Ø§
- Checklist
- Performance metrics
- Next steps

---

### 5ï¸âƒ£ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹

**ğŸ“– [README_HYBRID_VOICE_SYSTEM.md](README_HYBRID_VOICE_SYSTEM.md)**
- Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ (5 Ø¯Ù‚ÛŒÙ‚Ù‡)
- Quick start
- Code examples
- Troubleshooting
- Testing checklist

---

### 6ï¸âƒ£ Ú†Ú©Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ

**ğŸ“– [IMPLEMENTATION_CHECKLIST.md](IMPLEMENTATION_CHECKLIST.md)**
- Checklist Ù…ÙØµÙ„
- Ù…Ø±Ø§Ø­Ù„ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
- Time estimates
- Success criteria

---

## ğŸ—‚ï¸ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø¯

### Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ (Services)

#### 1. HybridVoiceRecorder.kt
**ğŸ“ Location:** `app/src/main/java/.../services/HybridVoiceRecorder.kt`

**Ù…Ø³Ø¦ÙˆÙ„ÛŒØª:** Ø¶Ø¨Ø· ØµØ¯Ø§ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ùˆ ØªØ­Ù„ÛŒÙ„ ØªØ±Ú©ÛŒØ¨ÛŒ

**Key Methods:**
```kotlin
fun startRecording()
fun stopRecording()
fun cancelRecording()
suspend fun analyzeOffline(audioFile: File): OfflineAnalysisResult
suspend fun analyzeOnline(audioFile: File): OnlineAnalysisResult
suspend fun analyzeHybrid(audioFile: File): HybridAnalysisResult
```

**Key Features:**
- âœ… Exception handling
- âœ… Resource cleanup
- âœ… Amplitude monitoring
- âœ… Offline/Online analysis

---

#### 2. VoiceRecordingService.kt
**ğŸ“ Location:** `app/src/main/java/.../services/VoiceRecordingService.kt`

**Ù…Ø³Ø¦ÙˆÙ„ÛŒØª:** Ø³Ø±ÙˆÛŒØ³ Ù¾ÛŒØ´â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø· ØµØ¯Ø§

**Key Methods:**
```kotlin
override fun onStartCommand(intent: Intent, flags: Int, startId: Int): Int
fun startRecording()
fun stopRecording()
fun cancelRecording()
fun isRecording(): Boolean
fun getRecordingDuration(): Long
```

**Key Features:**
- âœ… LifecycleService
- âœ… Foreground service
- âœ… Intent-based control
- âœ… Background support

---

#### 3. VoiceRecordingHelper.kt
**ğŸ“ Location:** `app/src/main/java/.../services/VoiceRecordingHelper.kt`

**Ù…Ø³Ø¦ÙˆÙ„ÛŒØª:** API Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Activities

**Key Methods:**
```kotlin
fun startRecording()
fun stopRecording()
fun cancelRecording()
fun setListener(listener: RecordingListener)
```

**Key Features:**
- âœ… Simple API
- âœ… Callback listeners
- âœ… Permission checks
- âœ… Lifecycle-aware

---

### UI Components

#### 4. VoiceRecorderViewNew.kt
**ğŸ“ Location:** `app/src/main/java/.../views/VoiceRecorderViewNew.kt`

**Ù…Ø³Ø¦ÙˆÙ„ÛŒØª:** Custom View Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø· ØµØ¯Ø§

**Key Methods:**
```kotlin
override fun onTouchEvent(event: MotionEvent): Boolean
private fun startRecording()
private fun stopRecording()
private fun cancelRecording()
private fun updateWaveform(amplitude: Int)
```

**Key Features:**
- âœ… Custom View
- âœ… Touch handling
- âœ… Waveform animation
- âœ… HybridVoiceRecorder integration

---

## ğŸ“Š Dependency Map

```
Activities (MainActivity, etc.)
    â†“
VoiceRecordingHelper (Simple API)
    â†“
HybridVoiceRecorder (Core Engine)
    â”œâ”€ MediaRecorder (Android SDK)
    â”œâ”€ Coroutines (Kotlin)
    â””â”€ File I/O (System)

VoiceRecordingService (Background)
    â”œâ”€ VoiceRecordingHelper
    â””â”€ HybridVoiceRecorder

VoiceRecorderViewNew (UI)
    â””â”€ HybridVoiceRecorder
```

---

## ğŸ¯ Ù‚Ø¨Ù„ Ùˆ Ø¨Ø¹Ø¯

### âŒ BEFORE
```
â”Œâ”€ User clicks mic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚
â”œâ”€ MediaRecorder init error    â”œâ†’ ğŸ’¥ CRASH
â”‚  (No error handling)         â”‚
â”‚                              â”‚
â”œâ”€ App closes                  â”‚
â”‚                              â”‚
â””â”€ Data lost â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### âœ… AFTER
```
â”Œâ”€ User clicks mic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                       â”‚
â”œâ”€ VoiceRecordingHelper                 â”œâ†’ Safe
â”‚                                       â”‚
â”œâ”€ HybridVoiceRecorder                  â”‚
â”‚  (Exception handling)                 â”‚
â”‚                                       â”‚
â”œâ”€ MediaRecorder starts                 â”‚
â”‚  (Protected with try-catch)           â”‚
â”‚                                       â”‚
â”œâ”€ Audio recorded                       â”‚
â”‚                                       â”‚
â”œâ”€ Analysis:                            â”‚
â”‚  â”œâ”€ Offline (Haaniye) - Fast         â”‚
â”‚  â””â”€ Online (Qwen/aimlapi) - Async    â”‚
â”‚                                       â”‚
â””â”€ Result delivered â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡

### Scenario 1: Simple Recording

```kotlin
// In Activity
val helper = VoiceRecordingHelper(this)

helper.setListener(object : VoiceRecordingHelper.RecordingListener {
    override fun onRecordingCompleted(file: File, duration: Long) {
        // Handle audio
    }
})

findViewById<Button>(R.id.recordButton).setOnClickListener {
    helper.startRecording()
}
```

---

### Scenario 2: Background Recording

```kotlin
// Start service
val intent = Intent(context, VoiceRecordingService::class.java).apply {
    action = "START_RECORDING"
}
context.startForegroundService(intent)

// Stop service
val stopIntent = Intent(context, VoiceRecordingService::class.java).apply {
    action = "STOP_RECORDING"
}
context.startService(stopIntent)
```

---

### Scenario 3: Hybrid Analysis

```kotlin
val recorder = HybridVoiceRecorder(context)

recorder.setListener(object : HybridVoiceRecorder.RecorderListener {
    override fun onRecordingCompleted(file: File, duration: Long) {
        GlobalScope.launch(Dispatchers.Main) {
            val result = recorder.analyzeHybrid(file)
            
            // Use both offline and online results
            println("Offline: ${result.offlineResult.text}")
            println("Online: ${result.onlineResult.analysis}")
            println("Combined: ${result.combinedText}")
        }
    }
})

recorder.startRecording()
```

---

## ğŸ“‹ Workflow Examples

### Complete Recording & Analysis Flow

```
1. User clicks Mic
   â””â”€ VoiceRecordingHelper.startRecording()
      â””â”€ HybridVoiceRecorder.startRecording()
         â””â”€ MediaRecorder.start()
            â””â”€ Amplitude monitoring started

2. Recording in progress
   â””â”€ Every 100ms: Amplitude update
      â””â”€ UI: Waveform animated

3. User releases Mic
   â””â”€ VoiceRecordingHelper.stopRecording()
      â””â”€ HybridVoiceRecorder.stopRecording()
         â””â”€ MediaRecorder.stop()
            â””â”€ onRecordingCompleted callback

4. Analysis starts
   â”œâ”€ Parallel:
   â”‚  â”œâ”€ analyzeOffline() (300-500ms)
   â”‚  â”‚  â””â”€ Load Haaniye model
   â”‚  â”‚  â””â”€ Process audio
   â”‚  â”‚  â””â”€ STT result
   â”‚  â”‚
   â”‚  â””â”€ analyzeOnline() (2-5s)
   â”‚     â””â”€ Upload to aimlapi
   â”‚     â””â”€ Qwen 2.5 1.5B processing
   â”‚     â””â”€ NER result
   â”‚
   â””â”€ Results merged
      â””â”€ onAnalysisComplete()
         â””â”€ UI updated
```

---

## ğŸ”§ Common Tasks

### Task 1: Add Voice Recording to Activity

**Steps:**
1. Copy code from `INTEGRATION_GUIDE.md`
2. Add VoiceRecordingHelper
3. Set up listener
4. Add mic button click handler
5. Test

**Time:** 15 minutes

---

### Task 2: Debug Recording Issue

**Steps:**
1. Check logs: `adb logcat HybridVoiceRecorder:V`
2. Check permissions in Manifest
3. Check device mic availability
4. Add breakpoints in `TESTING_DEBUGGING_GUIDE.md`
5. Use profiler if needed

**Time:** 30 minutes

---

### Task 3: Implement Offline Model

**Steps:**
1. Get Haaniye model from `assets/tts/haaniye/`
2. Implement `analyzeOffline()` method
3. Load model and process audio
4. Parse results
5. Test offline

**Time:** 2-4 hours

---

### Task 4: Implement Online Model

**Steps:**
1. Get aimlapi credentials
2. Implement `analyzeOnline()` method
3. Upload audio file
4. Parse response
5. Test online

**Time:** 2-4 hours

---

## ğŸ“Š Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§

```
Core Components:
â”œâ”€â”€ HybridVoiceRecorder (Media Recording)
â”‚   â”œâ”€â”€ MediaRecorder (Android SDK)
â”‚   â”œâ”€â”€ Kotlin Coroutines
â”‚   â”œâ”€â”€ File I/O
â”‚   â””â”€â”€ Handler (Amplitude monitoring)
â”‚
â”œâ”€â”€ VoiceRecordingService (Background)
â”‚   â”œâ”€â”€ LifecycleService
â”‚   â”œâ”€â”€ Notification
â”‚   â””â”€â”€ WakeLock
â”‚
â”œâ”€â”€ VoiceRecordingHelper (API)
â”‚   â””â”€â”€ VoiceRecordingHelper.RecordingListener
â”‚
â””â”€â”€ VoiceRecorderViewNew (UI)
    â”œâ”€â”€ Canvas (Drawing)
    â”œâ”€â”€ ValueAnimator (Animation)
    â””â”€â”€ MotionEvent (Touch)

External:
â”œâ”€â”€ Haaniye Model (Offline STT)
â”œâ”€â”€ aimlapi (Online API)
â””â”€â”€ Qwen 2.5 1.5B (Online LLM)
```

---

## âš¡ Quick References

### Import Statements

```kotlin
import android.media.MediaRecorder
import android.content.Intent
import androidx.lifecycle.LifecycleService
import kotlin.coroutines.*
import kotlinx.coroutines.*

import com.persianai.assistant.services.HybridVoiceRecorder
import com.persianai.assistant.services.VoiceRecordingService
import com.persianai.assistant.services.VoiceRecordingHelper
import com.persianai.assistant.views.VoiceRecorderViewNew
```

---

### Manifest Additions

```xml
<!-- Permissions (already added) -->
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />

<!-- Service -->
<service
    android:name=".services.VoiceRecordingService"
    android:foregroundServiceType="microphone" />
```

---

### Permission Checks

```kotlin
if (ContextCompat.checkSelfPermission(context, Manifest.permission.RECORD_AUDIO)
    != PackageManager.PERMISSION_GRANTED) {
    requestPermissions(arrayOf(Manifest.permission.RECORD_AUDIO), REQUEST_CODE)
}
```

---

## ğŸ“ Ø¨Ø®Ø´ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ

### Ú©Ø¬Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù¾Ø±Ø³Ø´ØŸ

| Ø³ÙˆØ§Ù„ | ÙØ§ÛŒÙ„ |
|-----|------|
| Ú†Ú¯ÙˆÙ†Ù‡ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ | VOICE_RECORDING_ARCHITECTURE.md |
| Ú†Ú¯ÙˆÙ†Ù‡ Ø§ØªØµØ§Ù„ Ú©Ù†Ù…ØŸ | INTEGRATION_GUIDE.md |
| Ú†Ú¯ÙˆÙ†Ù‡ ØªØ³Øª Ú©Ù†Ù…ØŸ | TESTING_DEBUGGING_GUIDE.md |
| Ø®Ø·Ø§ÛŒ X Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù… | TESTING_DEBUGGING_GUIDE.md - Troubleshooting |
| Ø³Ø±ÛŒØ¹ Ø´Ø±ÙˆØ¹ Ú©Ù† | README_HYBRID_VOICE_SYSTEM.md |
| Checklist Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù† | IMPLEMENTATION_CHECKLIST.md |

---

## âœ… Ù†ØªÛŒØ¬Ù‡â€ŒÚ¯ÛŒØ±ÛŒ

**Ø¨Ø§ Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§:**

1. âœ… Ù…ÛŒâ€ŒÙÙ‡Ù…ÛŒ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú†Ú¯ÙˆÙ†Ù‡ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
2. âœ… Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ØªØµØ§Ù„ Ú©Ù†ÛŒ Ø¯Ø± Activities
3. âœ… Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ ØªØ³Øª Ú©Ù†ÛŒ Ø¯Ø±Ø³Øª
4. âœ… Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ debug Ú©Ù†ÛŒ Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ Ø¯Ø§Ø´Øª
5. âœ… Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ implement Ú©Ù†ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ†
6. âœ… Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ø³Ø§Ø²ÛŒ production-ready solution

---

**ğŸ‰ Happy Coding!**

---

**Ù†Ø³Ø®Ù‡:** 1.0  
**Ø¢Ù¾Ø¯ÛŒØª:** 2024  
**ØªÙˆØ³Ø·:** AI Assistant
